# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This file contains annotation map data for P4 tables that the p4c backend
# expects to find when compiling Stratum P4 programs.
# TODO: Change the file name to reflect its common usage across
# all Stratum P4 roles,

# The L3 table annotations reference addenda that sets up a fallback or override
# VRF when the switch ultimately maps a P4 runtime table update to a flow entry.
# The first set of entries applies to the tables in the P4_16 version of
# tor.p4.

table_addenda_map {
  key: "ingress.l2_fwd_table"
  value {
    type: P4_TABLE_L2_MY_STATION
  }
}
table_addenda_map {
  key: "ingress.l2_fwd.l2_unicast_table"
  value {
    type: P4_TABLE_L2_UNICAST
    addenda_names: "l2-vlan-fallback"
  }
}
table_addenda_map {
  key: "ingress.l3_fwd.l3_routing_classifier_table"
  value {
    type: P4_TABLE_L2_MY_STATION
  }
}
table_addenda_map {
  key: "ingress.l3_fwd.l2_broadcast_table"
  value {
    type: P4_TABLE_L2_MULTICAST
    addenda_names: "l2-vlan-fallback"
  }
}
table_addenda_map {
  key: "ingress.l3_fwd_table"
  value {
    type: P4_TABLE_L3_IP
    #addenda_names: "l3-vrf-fallback"
  }
}
table_addenda_map {
  key: "ingress.l3_fwd.l3_fwd_table"
  value {
    type: P4_TABLE_L3_IP
    #addenda_names: "l3-vrf-fallback"
  }
}
table_addenda_map {
  key: "ingress.vrf_classifier_table"
  value {
    type: P4_TABLE_L3_IP
    addenda_names: "l3-vrf-fallback"
  }
}

# Defines an internal match on the fallback VRF ID.
table_addenda {
  name: "l3-vrf-fallback"
  internal_match_fields {
    type: P4_FIELD_TYPE_VRF
    value {
      u32: 2047  # kVrfFallback
    }
  }
}

# Defines an internal match on the override VRF ID.
table_addenda {
  name: "l3-vrf-override"
  internal_match_fields {
    type: P4_FIELD_TYPE_VRF
    value {
      u32: 2046  # kVrfOverride
    }
  }
}

# Defines an internal match on the default VLAN ID
table_addenda {
  name: "l2-vlan-fallback"
  internal_match_fields {
    type: P4_FIELD_TYPE_VLAN_VID
    value {
      u32: 1  # kDefaultVlan
    }
  }
}